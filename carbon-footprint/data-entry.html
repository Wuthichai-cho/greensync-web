<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CFO | GreenSync</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #198754; --navy-blue: #0f172a; --sidebar-width: 260px; --bg-light: #f1f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg-light); overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; background: white; position: fixed; top: 0; left: 0; border-right: 1px solid #e2e8f0; z-index: 1000; display: flex; flex-direction: column; }
        .brand-box { padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .menu-list { padding: 20px 10px; flex: 1; overflow-y: auto; }
        .menu-category { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; font-weight: 700; padding: 0 15px; margin-bottom: 10px; margin-top: 20px; }
        .menu-category:first-child { margin-top: 0; }
        .nav-link { color: #64748b; font-weight: 500; padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; transition: 0.3s; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background-color: #f0fdf4; color: var(--primary-color); }
        .main-content { margin-left: var(--sidebar-width); padding: 30px; }
        .upload-card { background: white; border-radius: 12px; padding: 30px; border: 1px solid #e2e8f0; height: 100%; }
        .border-dashed { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 12px; transition: 0.3s; cursor: pointer; }
        .border-dashed:hover { border-color: var(--primary-color); background: #f0fdf4; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        .animate-pulse { animation: pulse 1.5s infinite; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand-box">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <span class="fa-stack me-2" style="font-size: 1.2rem;">
                    <i class="fa-solid fa-leaf fa-stack-2x text-success"></i>
                </span>
                <span style="font-family: 'Prompt', sans-serif; font-weight: 700;">Green<span class="text-success">Sync</span></span>
            </a>
        </div>
        <div class="menu-list">
            <div class="menu-category">Menu</div>
            <a href="#" class="nav-link active"><i class="fa-solid fa-cloud-arrow-up me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CFO)</a>
        </div>
    </nav>

    <div class="main-content">
        <h3 class="fw-bold mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CFO</h3>
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="upload-card">
                    <h5 class="fw-bold mb-3"><i class="fa-solid fa-robot text-primary me-2"></i>1. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h5>
                    
                    <div class="border-dashed p-5 text-center position-relative" id="uploadArea">
                        <input type="file" id="fileInput" accept="image/*,.pdf" class="position-absolute top-0 start-0 w-100 h-100 opacity-0" style="cursor: pointer;">
                        <div class="mb-3"><div class="bg-white p-3 rounded-circle shadow-sm d-inline-block"><i class="fa-solid fa-cloud-arrow-up fa-2x text-primary"></i></div></div>
                        <h6 class="fw-bold mb-1">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏¥‡∏•‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h6>
                        <p class="text-muted small mb-0">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (PEA) ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</p>
                    </div>

                    <div id="ocrLoading" class="text-center mt-4" style="display: none;">
                        <div class="spinner-border text-primary mb-2" role="status"></div>
                        <p class="text-muted small animate-pulse">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>
                    </div>

                    <div id="ocrResult" class="mt-3 p-3 bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted d-block mb-1" id="ocrStatusText">‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</small>
                                <h3 class="fw-bold text-primary mb-0" id="ocrValueText">0.00 Unit</h3>
                            </div>
                            <button type="button" id="applyDataBtn" class="btn btn-primary shadow-sm"><i class="fa-solid fa-arrow-down me-2"></i>‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ</button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#debugCollapse">
                            <i class="fa-solid fa-code me-1"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö (Debug AI)
                        </button>
                        <div class="collapse mt-2" id="debugCollapse">
                            <div class="card card-body bg-dark text-light p-2 small" style="font-family: monospace; max-height: 150px; overflow-y: auto;" id="rawTextDisplay">
                                ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="col-lg-7">
                <div class="upload-card">
                    <h5 class="fw-bold mb-4">2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h5>
                    <form>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="fw-bold small text-muted">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                                <select class="form-select" id="activityType">
                                    <option value="elec">‚ö° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (PEA/MEA)</option>
                                    <option value="water">üíß ‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</option>
                                </select>
                            </div>
                            <div class="col-md-6"><label class="fw-bold small text-muted">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" class="form-control" value="2024-04"></div>
                            <div class="col-md-6">
                                <label class="fw-bold small text-muted">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì (Consumption)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control fw-bold" id="consumptionInput" placeholder="0.00">
                                    <span class="input-group-text bg-white text-muted" id="unitLabel">Unit</span>
                                </div>
                            </div>
                            <div class="col-md-6"><label class="fw-bold small text-muted">Emission Factor</label><input type="text" class="form-control bg-light" id="efInput" value="0.4999" readonly></div>
                            <div class="col-12 mt-3 p-3 bg-success bg-opacity-10 rounded"><h2 class="mb-0 fw-bold text-success text-end" id="totalCarbon">0.00 <span class="fs-6 text-muted">kgCO2e</span></h2></div>
                            <div class="col-12 mt-4 text-end"><button type="submit" class="btn btn-success px-4 fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const ocrResult = document.getElementById('ocrResult');
        const ocrLoading = document.getElementById('ocrLoading');
        const consumptionInput = document.getElementById('consumptionInput');
        const applyDataBtn = document.getElementById('applyDataBtn');
        const uploadArea = document.getElementById('uploadArea');
        const ocrStatusText = document.getElementById('ocrStatusText'); 
        const ocrValueText = document.getElementById('ocrValueText');
        const rawTextDisplay = document.getElementById('rawTextDisplay');
        const activityType = document.getElementById('activityType');

        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file) return;

            ocrLoading.style.display = 'block';
            ocrResult.style.display = 'none';
            uploadArea.style.opacity = '0.5';
            rawTextDisplay.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";

            try {
                // ‡πÇ‡∏´‡∏•‡∏î worker (‡πÉ‡∏ä‡πâ eng ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏ó‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å)
                const worker = await Tesseract.createWorker('tha+eng');
                const ret = await worker.recognize(file);
                const text = ret.data.text;
                
                // --- DEBUG: ‡πÇ‡∏ä‡∏ß‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö ---
                console.log("OCR Raw:", text);
                rawTextDisplay.innerText = text;

                // --- LOGIC ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡∏∞‡∏Ñ‡πà‡∏≤ ---
                let detectedValue = '0.00';
                let detectedType = 'unknown';

                // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏¥‡∏•‡∏à‡∏≤‡∏Å Keyword
                if (text.includes("‡πÑ‡∏ü‡∏ü‡πâ‡∏≤") || text.includes("PEA") || text.includes("MEA") || text.includes("kWh")) {
                    detectedType = 'elec';
                } else if (text.includes("‡∏õ‡∏£‡∏∞‡∏õ‡∏≤") || text.includes("MWA") || text.includes("PWA") || text.includes("‡∏ô‡πâ‡∏≥")) {
                    detectedType = 'water';
                }

                // 2. ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏Å‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 3 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü)
                const decimal3 = text.match(/[0-9,]+\.[0-9]{3}/g);
                // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡πâ‡∏≥)
                const integers = text.match(/\b\d+\b/g);

                if (detectedType === 'elec' && decimal3) {
                     // ‡∏™‡∏π‡∏ï‡∏£‡πÑ‡∏ü: ‡πÄ‡∏≠‡∏≤‡πÄ‡∏•‡∏Ç 3 ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0)
                     const nums = decimal3.map(n => parseFloat(n.replace(/,/g, ''))).filter(n => n > 0);
                     if (nums.length > 0) detectedValue = Math.min(...nums).toFixed(3);
                
                } else if (detectedType === 'water' && integers) {
                    // ‡∏™‡∏π‡∏ï‡∏£‡∏ô‡πâ‡∏≥: ‡∏•‡∏≠‡∏á‡∏´‡∏≤ A - B = C (‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏ï‡∏£ - ‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡∏¥‡∏° = ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ)
                    const nums = integers.map(n => parseInt(n)).filter(n => n > 0 && n < 10000);
                    nums.sort((a, b) => b - a); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                    
                    let foundMatch = false;
                    for (let i = 0; i < nums.length; i++) {
                        for (let j = i + 1; j < nums.length; j++) {
                            let diff = nums[i] - nums[j];
                            // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
                            if (nums.includes(diff) && diff > 0 && diff < 500) { // ‡∏ô‡πâ‡∏≥‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 500 ‡∏´‡∏ô‡πà‡∏ß‡∏¢
                                detectedValue = diff.toString();
                                foundMatch = true;
                                break;
                            }
                        }
                        if (foundMatch) break;
                    }
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏ö ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ô‡πâ‡∏≠‡∏¢‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡πâ‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô < 100)
                    if (!foundMatch) {
                        const candidates = nums.filter(n => n < 100 && n > 0);
                        if (candidates.length > 0) detectedValue = Math.min(...candidates).toString();
                    }
                } 
                
                // Fallback: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡πÅ‡∏ö‡∏ö‡∏°‡∏±‡πà‡∏ß‡πÜ
                if (detectedValue === '0.00') {
                    if (decimal3) detectedValue = decimal3[0]; // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
                    else if (integers) {
                        // ‡πÄ‡∏≠‡∏≤‡πÄ‡∏•‡∏Ç 2 ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô 19, 20)
                         const reasonable = integers.filter(n => n > 0 && n < 200);
                         if (reasonable.length > 0) detectedValue = reasonable[0];
                    }
                    detectedType = detectedType === 'unknown' ? 'elec' : detectedType;
                }

                // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
                ocrLoading.style.display = 'none';
                uploadArea.style.opacity = '1';
                ocrResult.style.display = 'block';

                const unit = detectedType === 'water' ? 'm3' : 'kWh';
                const label = detectedType === 'water' ? '‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥' : '‡∏ö‡∏¥‡∏•‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü';
                
                // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                if (detectedValue == '0.00' || detectedValue == '0') {
                    ocrStatusText.innerHTML = `<span class="text-danger"><i class="fa-solid fa-circle-exclamation me-1"></i>‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)</span>`;
                } else {
                    ocrStatusText.innerHTML = `<span class="text-success"><i class="fa-solid fa-check-circle me-1"></i>‡∏û‡∏ö${label}</span>`;
                }
                
                ocrValueText.innerHTML = `${detectedValue} ${unit}`;
                activityType.value = detectedType === 'water' ? 'water' : 'elec';

                applyDataBtn.onclick = () => {
                    consumptionInput.value = detectedValue;
                    document.getElementById('efInput').value = detectedType === 'water' ? '0.3400' : '0.4999';
                    document.getElementById('unitLabel').innerText = unit;
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô
                    const total = (parseFloat(detectedValue) * parseFloat(document.getElementById('efInput').value)).toFixed(2);
                    document.getElementById('totalCarbon').innerText = total;
                };

                await worker.terminate();

            } catch (error) {
                console.error(error);
                ocrLoading.style.display = 'none';
                alert("Error Reading File");
            }
        });
    </script>
</body>
</html>
