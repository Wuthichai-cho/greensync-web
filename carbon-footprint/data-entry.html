<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CFO | GreenSync</title>
    
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #198754; --navy-blue: #0f172a; --sidebar-width: 260px; --bg-light: #f1f5f9; }
        body { font-family: 'Prompt', sans-serif; background-color: var(--bg-light); overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); height: 100vh; background: white; position: fixed; top: 0; left: 0; border-right: 1px solid #e2e8f0; z-index: 1000; display: flex; flex-direction: column; }
        .brand-box { padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .menu-list { padding: 20px 10px; flex: 1; overflow-y: auto; }
        .nav-link { color: #64748b; font-weight: 500; padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background-color: #f0fdf4; color: var(--primary-color); }
        .main-content { margin-left: var(--sidebar-width); padding: 30px; }
        .upload-card { background: white; border-radius: 12px; padding: 30px; border: 1px solid #e2e8f0; height: 100%; }
        .border-dashed { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 12px; transition: 0.3s; cursor: pointer; }
        .border-dashed:hover { border-color: var(--primary-color); background: #f0fdf4; }
        
        /* Canvas ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (Debug) */
        canvas { max-width: 100%; height: auto; border: 1px solid #ddd; display: none; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand-box">
            <span class="fs-4 fw-bold">Green<span class="text-success">Sync</span></span>
        </div>
        <div class="menu-list">
            <a href="#" class="nav-link active"><i class="fa-solid fa-cloud-arrow-up me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CFO)</a>
        </div>
    </nav>

    <div class="main-content">
        <h3 class="fw-bold mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏¥‡∏•‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (OCR + OpenCV)</h3>
        
        <div class="alert alert-info small py-2">
            <i class="fa-solid fa-circle-info me-2"></i> 
            ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ <b>Computer Vision (OpenCV)</b> ‡∏õ‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡πà‡∏≤‡∏ô ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏î‡πâ 40-50%
            <span id="cvStatus" class="float-end badge bg-warning text-dark">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î OpenCV...</span>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="upload-card">
                    <h5 class="fw-bold mb-3">1. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                    
                    <div class="border-dashed p-4 text-center position-relative" id="uploadArea">
                        <input type="file" id="fileInput" accept="image/*" class="position-absolute top-0 start-0 w-100 h-100 opacity-0" style="cursor: pointer;">
                        <i class="fa-solid fa-cloud-arrow-up fa-2x text-primary mb-2"></i>
                        <h6 class="fw-bold mb-0">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ö‡∏¥‡∏•</h6>
                        <small class="text-muted">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (JPG/PNG)</small>
                    </div>

                    <div class="mt-3 text-center">
                        <small class="text-muted d-block mb-1">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà AI ‡πÄ‡∏´‡πá‡∏ô (Pre-processed):</small>
                        <canvas id="canvasOutput"></canvas>
                        <img id="imageSrc" style="display:none;" />
                    </div>

                    <div id="ocrLoading" class="text-center mt-3" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <small class="ms-2">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</small>
                    </div>

                    <div id="ocrResult" class="mt-3 p-3 bg-primary bg-opacity-10 rounded-3 border border-primary border-opacity-25" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted d-block" id="ocrStatusText">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</small>
                                <h3 class="fw-bold text-primary mb-0" id="ocrValueText">0.00</h3>
                            </div>
                            <button id="applyDataBtn" class="btn btn-sm btn-primary">‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ</button>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <a class="text-secondary small text-decoration-none" data-bs-toggle="collapse" href="#debugBox" role="button">
                            <i class="fa-solid fa-code"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö
                        </a>
                        <div class="collapse" id="debugBox">
                            <div class="card card-body bg-dark text-white p-2 small mt-1" id="rawTextDisplay" style="height: 100px; overflow-y: auto; font-family: monospace;"></div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="col-lg-7">
                <div class="upload-card">
                    <h5 class="fw-bold mb-3">2. ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h5>
                    <form>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="small fw-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <select class="form-select" id="activityType">
                                    <option value="elec">‚ö° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</option>
                                    <option value="water">üíß ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</option>
                                </select>
                            </div>
                            <div class="col-6"><label class="small fw-bold">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" class="form-control" value="2024-04"></div>
                            <div class="col-6">
                                <label class="small fw-bold">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
                                <input type="number" class="form-control fw-bold" id="consumptionInput" placeholder="0.00">
                            </div>
                            <div class="col-6">
                                <label class="small fw-bold">‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô (kgCO2e)</label>
                                <input type="text" class="form-control bg-light" id="totalCarbon" readonly value="0.00">
                            </div>
                            <div class="col-12 text-end"><button class="btn btn-success fw-bold px-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   // ... (‡∏™‡πà‡∏ß‡∏ô HTML ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...

    <script>
        const fileInput = document.getElementById('fileInput');
        const ocrResult = document.getElementById('ocrResult');
        const ocrLoading = document.getElementById('ocrLoading');
        const consumptionInput = document.getElementById('consumptionInput');
        const applyDataBtn = document.getElementById('applyDataBtn');
        const uploadArea = document.getElementById('uploadArea');
        const ocrStatusText = document.getElementById('ocrStatusText'); 
        const ocrValueText = document.getElementById('ocrValueText');
        const activityType = document.getElementById('activityType');
        const efInput = document.getElementById('efInput');
        const unitLabel = document.getElementById('unitLabel');
        const totalCarbonDisplay = document.getElementById('totalCarbon');

        fileInput.addEventListener('change', async () => {
            const file = fileInput.files[0];
            if (!file) return;

            // 1. Loading UI
            ocrLoading.style.display = 'block';
            ocrResult.style.display = 'none';
            uploadArea.style.opacity = '0.5';

            try {
                // 2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Tesseract ‡∏≠‡πà‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ tha+eng)
                const worker = await Tesseract.createWorker('tha+eng');
                const ret = await worker.recognize(file);
                const text = ret.data.text;
                console.log("OCR Raw Text:", text); // Debug ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤‡∏ö‡πâ‡∏≤‡∏á

                // --- SMART LOGIC V.4 (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å) ---
                
                let detectedValue = '0.00';
                let detectedType = 'elec'; // Default ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü
                let foundCandidate = false;

                // A. ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏¥‡∏•‡∏à‡∏≤‡∏Å Keyword
                if (text.includes('‡∏õ‡∏£‡∏∞‡∏õ‡∏≤') || text.includes('MWA') || text.includes('PWA') || text.includes('‡∏ô‡πâ‡∏≥')) {
                    detectedType = 'water';
                }

                // B. ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ (‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô)
                // Regex ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 1,234.56 ‡πÅ‡∏•‡∏∞ 1234
                const allNumbers = text.match(/[0-9,]+(\.[0-9]+)?/g);
                
                if (allNumbers) {
                    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Float ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡∏¢‡∏∞‡∏≠‡∏≠‡∏Å
                    let nums = allNumbers.map(n => parseFloat(n.replace(/,/g, '')))
                        .filter(n => {
                            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ô‡πà‡∏≤‡πÉ‡∏ä‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ
                            return !isNaN(n) && 
                                   n > 0 && 
                                   n < 100000 && // ‡πÄ‡∏•‡∏Ç‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏™‡∏ô‡∏°‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                                   n !== 2566 && n !== 2567 && n !== 2023 && n !== 2024 && n !== 2025; // ‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ
                        });

                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏ö‡πÄ‡∏•‡∏Ç)
                    nums.sort((a, b) => b - a);
                    console.log("Cleaned Numbers:", nums);

                    // C. ‡∏™‡∏π‡∏ï‡∏£ "The Perfect Match" (‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô - ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ = ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ)
                    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                    for (let i = 0; i < nums.length; i++) {
                        for (let j = i + 1; j < nums.length; j++) {
                            let diff = nums[i] - nums[j];
                            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (diff) ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°?
                            // ‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ 0.01 (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô)
                            let match = nums.find(n => Math.abs(n - diff) < 0.02);
                            
                            if (match) {
                                console.log(`Found Formula: ${nums[i]} - ${nums[j]} = ${match}`);
                                detectedValue = match.toString();
                                foundCandidate = true;
                                break; // ‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡∏¢! ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                            }
                        }
                        if (foundCandidate) break;
                    }

                    // D. ‡∏ñ‡πâ‡∏≤‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (Fallback) -> ‡πÉ‡∏ä‡πâ Heuristic ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà "‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î"
                    if (!foundCandidate && nums.length > 0) {
                        console.log("Math formula failed, using heuristic...");
                        
                        if (detectedType === 'elec') {
                            // ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤: ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2-3 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡∏´‡∏•‡∏±‡∏Å‡∏û‡∏±‡∏ô)
                            // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏• (‡πÄ‡∏ä‡πà‡∏ô < 1000)
                            // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏Å‡πá‡πÄ‡∏≠‡∏≤‡πÄ‡∏•‡∏Ç‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠
                            let candidates = nums.filter(n => n < 2000); 
                            if(candidates.length === 0) candidates = nums;
                            detectedValue = Math.min(...candidates).toString();
                        } else {
                            // ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤: ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° ‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≠‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 10-50 ‡∏´‡∏ô‡πà‡∏ß‡∏¢)
                            let candidates = nums.filter(n => Number.isInteger(n) && n < 200);
                            if (candidates.length > 0) {
                                detectedValue = Math.min(...candidates).toString();
                            } else {
                                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° ‡πÄ‡∏≠‡∏≤‡πÄ‡∏•‡∏Ç‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î
                                detectedValue = Math.min(...nums).toString();
                            }
                        }
                    }
                }

                // --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ---
                ocrLoading.style.display = 'none';
                uploadArea.style.opacity = '1';
                ocrResult.style.display = 'block';

                let unit = detectedType === 'water' ? 'm3' : 'kWh';
                let icon = detectedType === 'water' ? 'fa-water' : 'fa-bolt';
                let typeName = detectedType === 'water' ? '‡∏õ‡∏£‡∏∞‡∏õ‡∏≤' : '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤';

                ocrStatusText.innerHTML = `<i class="fa-solid ${icon} me-1"></i>‡∏û‡∏ö‡∏ö‡∏¥‡∏•${typeName}`;
                ocrValueText.innerText = `${parseFloat(detectedValue).toFixed(2)} ${unit}`;
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î
                applyDataBtn.onclick = () => {
                    activityType.value = detectedType;
                    updateFactor(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢/EF
                    consumptionInput.value = parseFloat(detectedValue).toFixed(2);
                    calculateCarbon(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô
                };

                await worker.terminate();

            } catch (error) {
                console.error(error);
                ocrLoading.style.display = 'none';
                uploadArea.style.opacity = '1';
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢
        function updateFactor() {
            if(activityType.value === 'water') {
                efInput.value = '0.3400';
                unitLabel.innerText = 'm3';
            } else {
                efInput.value = '0.4999';
                unitLabel.innerText = 'kWh';
            }
        }

        function calculateCarbon() {
            const val = parseFloat(consumptionInput.value) || 0;
            const ef = parseFloat(efInput.value) || 0;
            totalCarbonDisplay.innerText = (val * ef).toFixed(2);
        }

        // Event Listeners ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°...
        consumptionInput.addEventListener('input', calculateCarbon);
        activityType.addEventListener('change', () => { updateFactor(); calculateCarbon(); });
        // Drag & Drop listeners... (‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.backgroundColor = '#f0fdf4'; uploadArea.style.borderColor = '#198754'; });
        uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.style.backgroundColor = '#f8fafc'; uploadArea.style.borderColor = '#cbd5e1'; });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); fileInput.files = e.dataTransfer.files; fileInput.dispatchEvent(new Event('change')); uploadArea.style.backgroundColor = '#f8fafc'; });

    </script>
</body>
</html>

